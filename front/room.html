<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rooms</title>
    <link rel="stylesheet" href="room.css">
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Boxicons -->
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
            
</head>
<body>
    <header>
        <img src="images/logo.jpeg" width="150">
        <span id="userGreeting" style="float: right; margin: 10px;"></span>
    </header>

    <div class="RRoomm">
        <h2>Patient Room Management System</h2>
        <div id="loading">
            <i class='bx bx-loader-alt bx-spin'></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ù...
        </div>
        <div id="floors-container" style="display: none;"></div>
        <div id="patient-info" class="patient-info" style="display: none;"></div>
    </div>

    <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <div class="menu-button" id="menuButton" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div class="side-menu" id="sideMenu">
        <a href="home.html">Home</a>
        <a href="creat_entry.html">Creat_Entry</a>
        <a href="room.html">Rooms</a>
        <a href="valve&time.html">valve&time</a>
        <a href="Features.html">Features</a>
        <a href="reviwe.html">reviwe</a>
        <a href="help.html">Help</a>
        <a href="#" id="logoutBtn">Logout</a>
    </div>

    <!-- ØºØ·Ø§Ø¡ Ø´ÙØ§Ù Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <div class="overlay" id="overlay" onclick="closeMenu()"></div>

    <script>
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ù (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ©)
        let floors = [
    { name: "First Floor", rooms: [{ id: 101, room_number: 101, occupied: true }] },
    { name: "Second Floor", rooms: [{ id: 201, room_number: 201, occupied: false }] }
];

    
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ù Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ©
        async function fetchRooms() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('floors-container');
    const token = localStorage.getItem('authToken');

    try {
        if (!token) {
            throw new Error("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        }

        loading.style.display = "block";
        container.style.display = "none";

        const response = await fetch('/api/rooms', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error("Failed to fetch rooms");
        }

        const data = await response.json();
        console.log("API response:", data);

        if (!data.rooms || !Array.isArray(data.rooms)) {
            throw new Error("Invalid rooms data received");
        }

        // ØªÙ†Ø¸ÙŠÙ… Ø§Ù„ØºØ±Ù Ø­Ø³Ø¨ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚
        const newFloors = {};  // Ø§Ø³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† `floors`
        data.rooms.forEach(room => {
            if (!newFloors[room.floor]) {
                newFloors[room.floor] = [];
            }
            newFloors[room.floor].push({
                id: room.id,
                room_number: room.room_number,
                floor: room.floor,
                occupied: room.occupied,
                patient: {
                    name: room.patient_name || "",
                    age: room.patient_age || "",
                    doctor: room.doctor_name || "",
                    blood_group: room.blood_group || "",
                    drip_status: room.valve_status || ""
                }
            });
        });

        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§ Ø¯Ø§Ù„Ø© renderFloors
        const floorsArray = Object.keys(newFloors).map(floorNumber => ({
            name: `Floor ${floorNumber}`,
            rooms: newFloors[floorNumber]
        }));

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… `floors`
        floors = floorsArray;
        renderFloors();

    } catch (err) {
        console.error("Error fetching rooms:", err);
        alert(err.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    } finally {
        loading.style.display = "none";
        container.style.display = "block";
    }
}


function updateRoomsUI(rooms) {
  const container = document.getElementById("floors-container");
  container.innerHTML = "";
  
  // ØªÙ†Ø¸ÙŠÙ… Ø§Ù„ØºØ±Ù Ø­Ø³Ø¨ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚
  const floors = {};
  rooms.forEach(room => {
    if (!floors[room.floor]) {
      floors[room.floor] = [];
    }
    floors[room.floor].push(room);
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„ØºØ±Ù Ù„ÙƒÙ„ Ø·Ø§Ø¨Ù‚
  Object.entries(floors).forEach(([floorNumber, floorRooms]) => {
    const floorDiv = document.createElement("div");
    floorDiv.classList.add("floor");
    floorDiv.innerHTML = `<h3>Floor ${floorNumber}</h3>`;
    
    floorRooms.forEach(room => {
      const card = document.createElement("div");
      card.classList.add("room-card", room.occupied ? "occupied" : "empty");
      
      card.innerHTML = `
        <i class='bx bx-bed icon'></i>
        <div class="room-id">${room.room_number}</div>
        <div class="status">${room.occupied ? "Occupied" : "Available"}</div>
        <div class="action">${room.occupied ? "View Details" : "Book Room"}</div>
      `;
      
      card.onclick = () => showPatientInfo(room);
      floorDiv.appendChild(card);
    });
    
    container.appendChild(floorDiv);
  });
}

        // Ø¹Ø±Ø¶ Ø§Ù„ØºØ±Ù
        function renderFloors() {
            let container = document.getElementById("floors-container");
            container.innerHTML = "";

            floors.forEach(floor => {
                let floorDiv = document.createElement("div");
                floorDiv.classList.add("floor");
                floorDiv.innerHTML = `<h3>${floor.name}</h3>`;

                floor.rooms.forEach(room => {
                    let card = document.createElement("div");
                    card.classList.add("room-card", room.occupied ? "occupied" : "empty");

                    const icon = "<i class='bx bx-bed icon'></i>";
                    const roomId = `<div class="room-id">${room.room_number}</div>`;
                    const status = `<div class="status">${room.occupied ? "Occupied" : "Available"}</div>`;
                    const action = `<div class="action">${room.occupied ? "View Details" : "Book Room"}</div>`;

                    card.innerHTML = icon + roomId + status + action;
                    card.onclick = () => showPatientInfo(room);
                    floorDiv.appendChild(card);
                });

                container.appendChild(floorDiv);
            });
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        function showPatientInfo(room) {
            let infoDiv = document.getElementById("patient-info");
            infoDiv.style.display = "block";
 
            if (!room.occupied) {
                infoDiv.innerHTML = `
                    <p style="color: green; font-weight: bold;">ğŸšª Room ${room.room_number} is available</p>
                    <button onclick="reserveRoom(${room.id})">Book Room</button>
                `;
                return;
            }

            let patient = room.patient;
            infoDiv.innerHTML = `
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©:</strong> ${room.room_number}</p>
                <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patient.name}</p>
                <p><strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${patient.age}</p>
                <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> ${patient.doctor}</p>
                <p><strong>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…:</strong> ${patient.blood_group}</p>
                <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØºØ°ÙŠ:</strong> ${patient.drip_status}</p>
                <button onclick="checkoutPatient(${room.id})">Check Out</button>
            `;
        }

        // Ø­Ø¬Ø² ØºØ±ÙØ©
        function reserveRoom(roomId) {
            window.location.href = `creat_entry.html?room_id=${roomId}`;
        }

        // Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø±ÙŠØ¶
        async function checkoutPatient(roomId) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø±ÙŠØ¶ØŸ")) return;

  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch(`/api/rooms/${roomId}/checkout`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || result.details || 'ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
    }

    alert(result.message);
    fetchRooms(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('patient-info').style.display = 'none';

  } catch (error) {
    console.error('Checkout Failed:', error);
    alert(`âŒ Ø®Ø·Ø£: ${error.message}`);
  }
}

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userData = localStorage.getItem('user');
            
            if (!token || !userData) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userData);
                document.getElementById('userGreeting').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.name}`;
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        const menu = document.getElementById("sideMenu");
        const button = document.getElementById("menuButton");
        const overlay = document.getElementById("overlay");

        function toggleMenu() {
            menu.classList.toggle("open");
            button.classList.toggle("open");
            overlay.classList.toggle("active");
        }

        function closeMenu() {
            menu.classList.remove("open");
            button.classList.remove("open");
            overlay.classList.remove("active");
        }

        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            fetchRooms();
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', {message, source, lineno, colno, error});
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª.');
            return true;
        };
    </script>
</body>
</html>
