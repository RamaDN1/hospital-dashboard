<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³Ø¬Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</title>
  <link rel="stylesheet" href="patientsrev.css"/>
</head>
<body>
    <header>
        <img src="images/logo.jpeg" width="150">
    </header><br>

  <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <div class="toggle-menu-btn" id="menuButton" onclick="toggleMenu()">
    <span></span><span></span><span></span>
  </div>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <div class="sidebar-menu" id="sideMenu">
    <a href="home.html">Home</a>
    <a href="creat_entry.html">Creat_Entry  </a>
    <a href="room.html">Rooms</a>
    <a href="valve&time.html">valve&time </a>
    <a href="Features.html">Features</a>
    <a href="reviwe.html">Review </a>
    <a href="help.html">Help</a>
  </div>

  <!-- Ø§Ù„ØºØ·Ø§Ø¡ -->
  <div class="menu-overlay" id="overlay" onclick="closeMenu()"></div>

  <div class="container">
    <a class="back-btn" href="creat_entry.html"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©</a>
    <h2>ğŸ“‹ Ø³Ø¬Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
    <table id="reviewHistoryTable">
      <thead>
        <tr>
          <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>â° Ø§Ù„ÙˆÙ‚Øª</th>
          <th>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
          <th>ğŸ¥ Ø³Ø¨Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
          <th>ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ 12 Ø³Ø§Ø¹Ø© Ù…Ø¹ AM/PM
    function formatTime(time) {
      const [hour, minute] = time.split(":");
      let hour12 = parseInt(hour, 10);
      const ampm = hour12 >= 12 ? 'Ù…' : 'Øµ';
      hour12 = hour12 % 12;
      if (hour12 === 0) hour12 = 12; // Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 0 ØªÙƒÙˆÙ† 12
      return `${hour12}:${minute} ${ampm}`;
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    function formatDate(date) {
      return new Date(date).toLocaleDateString('ar-SA', { calendar: 'gregory' }); // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ø¯
    }

    // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù„Ù„Ù…Ø±ÙŠØ¶
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('id');

    if (patientId) {
      loadReviewHistory(patientId);
    } else {
      document.querySelector("#reviewHistoryTable tbody").innerHTML =
        "<tr><td colspan='5'>âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙŠØ¶</td></tr>";
    }

    async function loadReviewHistory(patientId) {
      try {
          const res = await fetch(`/api/reviews/patient/${patientId}`, {
              headers: {
                  'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              }
          });
          const data = await res.json();

          console.log('Received review history data:', data);

          const tbody = document.querySelector("#reviewHistoryTable tbody");
          tbody.innerHTML = "";

          if (!data.history || data.history.length === 0) {
              tbody.innerHTML = "<tr><td colspan='5'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>";
              return;
          }

          data.history.forEach(row => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                  <td>${formatDate(row.review_date)}</td> <!-- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
                  <td>${formatTime(row.review_time)}</td> <!-- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª -->
                  <td><textarea class="doctor-notes" id="doctorNotes-${row.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨">${row.doctor_notes || ''}</textarea></td>
                  <td>${row.admission_reason || 'â€”'}</td>
                  <td><button onclick="updateNotes('${row.id}')">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button></td>
              `;
              tbody.appendChild(tr);
          });
      } catch (err) {
          console.error("Error loading review history:", err);
          document.querySelector("#reviewHistoryTable tbody").innerHTML =
              "<tr><td colspan='5'>âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
      }
    }

    async function updateNotes(reviewId) {
      console.log("Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡Ø§:", reviewId);
      
      if (!reviewId) {
          alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
          return;
      }

      const notes = document.getElementById(`doctorNotes-${reviewId}`).value;

      if (!notes.trim()) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨.');
          return;
      }

      try {
          const response = await fetch(`/api/reviews/update/${reviewId}`, {
              method: 'PUT',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify({ doctor_notes: notes })
          });

          const data = await response.json();
          if (response.ok) {
              alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          } else {
              alert(`ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.error}`);
          }
      } catch (err) {
          console.error('Error updating notes:', err);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
      }
    }
  </script>
</body>
</html>




